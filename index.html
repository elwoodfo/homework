<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Учёба</title>
  <style>
    :root { --bg:#0b0f17; --card:#121a2a; --text:#e8eefc; --muted:#9fb0d0; --accent:#6aa6ff; --border:#22304c; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:linear-gradient(180deg,#0b0f17,#070a10); color:var(--text); }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{ padding:24px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:rgba(11,15,23,.9); backdrop-filter: blur(10px); }
    .wrap{ max-width:1100px; margin:0 auto; padding:0 16px; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; }
    main{ padding:18px 0 40px; }
    .grid{ display:grid; gap:12px; grid-template-columns: repeat(12, 1fr); }
    .card{ grid-column: span 12; background:rgba(18,26,42,.9); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    @media (min-width: 860px){ .card.span6{ grid-column: span 6; } .card.span4{ grid-column: span 4; } .card.span8{ grid-column: span 8; } }
    .card h2{ margin:0 0 10px; font-size:16px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .btn{ appearance:none; border:1px solid var(--border); background:#0d1424; color:var(--text); padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn:hover{ border-color:#35558f; }
    .btn.primary{ background:linear-gradient(180deg,#1b3a7a,#132654); border-color:#2e4f8b; }
    .list{ display:grid; gap:10px; }
    .item{ border:1px solid var(--border); border-radius:14px; padding:12px; display:flex; justify-content:space-between; gap:10px; align-items:flex-start; background:rgba(10,16,30,.55); }
    .meta{ color:var(--muted); font-size:12px; margin-top:4px; }
    .right{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .muted{ color:var(--muted); }
    .err{ color:#ffb4b4; }
    .modalBack{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px; }
    .modal{ width:min(820px,100%); background:var(--card); border:1px solid var(--border); border-radius:18px; padding:14px; }
    .modalHead{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .modalHead h3{ margin:0; font-size:16px; }
    .modalBody{ margin-top:10px; white-space:pre-wrap; line-height:1.35; }
    .close{ background:transparent; border:1px solid var(--border); color:var(--text); border-radius:12px; padding:8px 10px; cursor:pointer; }
    .close:hover{ border-color:#35558f; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Учёба</h1>
      <div class="sub" id="metaLine">Загрузка…</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card span6">
        <h2>Ссылки</h2>
        <div class="row" id="hardLinks"></div>
        <div class="sub">Эти ссылки зашиты в коде сайта.</div>
      </section>

      <section class="card span6">
        <h2>Требования к автомату</h2>
        <div id="autoBox" class="muted">Загрузка…</div>
      </section>

      <section class="card span12">
        <h2>Предметы</h2>
        <div id="subjectsList" class="list"></div>
        <div class="sub">Кнопка «ДЗ» показывает данные из Google Таблицы (лист <b>homework</b>).</div>
      </section>
    </div>
  </main>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <div class="modalHead">
        <div>
          <h3 id="modalTitle">ДЗ</h3>
          <div class="sub" id="modalSub"></div>
        </div>
        <button class="close" id="modalClose">Закрыть</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    // ВСТАВЬ URL Web App Apps Script (/exec)
    const SHEETS_API_URL = "https://script.google.com/macros/s/AKfycbw096q4_keSu8JHESWost-d547EvQiQRMj2I2YE0dQPm17yfseBv3Bxf6SnSqcUFCPbPg/exec";

    // ====== ЖЁСТКО ЗАДАННЫЕ ССЫЛКИ ======
    const LINKS = [
      { title: "Вступление в группу (VK)", url: "https://vk.com/..." },
      { title: "Очередь", url: "https://..." },
      { title: "Требования к автомату (если есть отдельная ссылка)", url: "https://..." },
      { title: "Веб-версия приложения", url: "https://..." },
    ];

    // ====== ЖЁСТКО ЗАДАННЫЕ ПРЕДМЕТЫ ======
    const SUBJECTS = [
      { name: "Математика", teacher: "Иванова", groupUrl: "https://vk.com/..." },
      { name: "Физика", teacher: "Петров", groupUrl: "https://t.me/..." },
      // добавляй сколько нужно
    ];

    const el = (id) => document.getElementById(id);

    function fmtDate(v){
      if (!v) return "";
      try {
        const d = new Date(v);
        if (isNaN(d.getTime())) return String(v);
        return d.toLocaleString("ru-RU", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      } catch { return String(v); }
    }

    function openModal({title, sub, body}){
      el("modalTitle").textContent = title || "ДЗ";
      el("modalSub").textContent = sub || "";
      el("modalBody").textContent = body || "";
      el("modalBack").style.display = "flex";
      el("modalBack").setAttribute("aria-hidden", "false");
    }
    function closeModal(){
      el("modalBack").style.display = "none";
      el("modalBack").setAttribute("aria-hidden", "true");
    }
    el("modalClose").addEventListener("click", closeModal);
    el("modalBack").addEventListener("click", (e) => { if (e.target === el("modalBack")) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    function renderHardLinks(){
      const wrap = el("hardLinks");
      wrap.innerHTML = "";
      LINKS.forEach(l => {
        const a = document.createElement("a");
        a.className = "btn primary";
        a.href = l.url;
        a.target = "_blank";
        a.rel = "noopener";
        a.textContent = l.title;
        wrap.appendChild(a);
      });
    }

    function renderSubjects(hwBySubject){
      const list = el("subjectsList");
      list.innerHTML = "";

      SUBJECTS.forEach(s => {
        const row = document.createElement("div");
        row.className = "item";

        const left = document.createElement("div");
        left.innerHTML = `
          <div style="font-weight:800">${escapeHtml(s.name)}</div>
          <div class="meta">${escapeHtml(s.teacher ? "Преподаватель: " + s.teacher : "")}</div>
        `;

        const right = document.createElement("div");
        right.className = "right";

        if (s.groupUrl) {
          const a = document.createElement("a");
          a.className = "btn";
          a.href = s.groupUrl;
          a.target = "_blank";
          a.rel = "noopener";
          a.textContent = "Группа";
          right.appendChild(a);
        }

        const btn = document.createElement("button");
        btn.className = "btn primary";
        btn.textContent = "ДЗ";
        btn.onclick = () => {
          const items = hwBySubject.get(s.name) || [];
          if (!items.length) {
            openModal({ title: `ДЗ — ${s.name}`, sub: "", body: "Пока нет записей в Google Таблице (лист homework)." });
            return;
          }
          // берём первую запись; хочешь — сделаю сортировку по updated/due
          const x = items[0];
          const sub = [
            x.due ? `Дедлайн: ${x.due}` : "",
            x.updated ? `Обновлено: ${fmtDate(x.updated)}` : ""
          ].filter(Boolean).join(" • ");
          const body = `${x.title ? x.title + "\n\n" : ""}${x.text || ""}`;
          openModal({ title: `ДЗ — ${s.name}`, sub, body });
        };
        right.appendChild(btn);

        row.appendChild(left);
        row.appendChild(right);
        list.appendChild(row);
      });
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    async function loadData(){
      renderHardLinks();

      if (!SHEETS_API_URL || SHEETS_API_URL.includes("PASTE_")) {
        el("metaLine").innerHTML = `<span class="err">Нужно вставить SHEETS_API_URL в index.html</span>`;
        renderSubjects(new Map());
        return;
      }

      let data;
      try {
        const res = await fetch(SHEETS_API_URL, { cache:"no-store" });
        if (!res.ok) throw new Error("HTTP " + res.status);
        data = await res.json();
      } catch (e) {
        el("metaLine").innerHTML = `<span class="err">Ошибка загрузки: ${String(e.message || e)}</span>`;
        renderSubjects(new Map());
        return;
      }

      el("metaLine").textContent = `Обновлено: ${fmtDate(data?.meta?.generatedAt)}`;

      // Автомат
      const ar = Array.isArray(data.auto_requirements) ? data.auto_requirements : [];
      if (!ar.length) el("autoBox").textContent = "Нет данных в auto_requirements.";
      else {
        const a = ar[0];
        el("autoBox").innerHTML =
          `<div class="meta">${a.updated ? "Обновлено: " + escapeHtml(fmtDate(a.updated)) : ""}</div>` +
          `<div style="white-space:pre-wrap;line-height:1.35;margin-top:8px;">${escapeHtml(a.text || "")}</div>`;
      }

      // ДЗ
      const hw = Array.isArray(data.homework) ? data.homework : [];
      const hwBySubject = new Map();
      hw.forEach(x => {
        const s = String(x.subject || "").trim();
        if (!s) return;
        if (!hwBySubject.has(s)) hwBySubject.set(s, []);
        hwBySubject.get(s).push(x);
      });

      renderSubjects(hwBySubject);
    }

    loadData();
  </script>
</body>
</html>
